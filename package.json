// âœ… server.js â€“ Fio API proxy
import express from "express";
import fetch from "node-fetch";
import cors from "cors";
import xml2js from "xml2js";
import dotenv from "dotenv";

// NaÄti promÄ›nnÃ© z .env (napÅ™. FIO_TOKEN)
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;
const FIO_TOKEN = process.env.FIO_TOKEN;

// PovolenÃ­ CORS â€“ aby mohl pÅ™istupovat frontend z GitHub Pages
app.use(cors());

// HlavnÃ­ endpoint
app.get("/fio", async (req, res) => {
  try {
    if (!FIO_TOKEN) {
      return res.status(500).json({ error: "ChybÃ­ FIO_TOKEN v prostÅ™edÃ­" });
    }

    const url = `https://www.fio.cz/ib_api/rest/getAccountInfo/${FIO_TOKEN}/xml`;
    const response = await fetch(url);

    if (!response.ok) {
      return res.status(response.status).json({ error: "Chyba pÅ™i naÄÃ­tÃ¡nÃ­ z Fio API" });
    }

    const xml = await response.text();

    // PÅ™evod XML â†’ JSON
    const parsed = await xml2js.parseStringPromise(xml, { explicitArray: false });

    // BezpeÄnÃ© vyÄtenÃ­ zÅ¯statku
    const balance =
      parsed?.accountStatement?.info?.closingBalance
        ? parseFloat(parsed.accountStatement.info.closingBalance)
        : 0;

    res.json({ balance });
  } catch (err) {
    console.error("âŒ Chyba Fio proxy:", err);
    res.status(500).json({ error: "Chyba serveru pÅ™i zpracovÃ¡nÃ­ dat" });
  }
});

// ZÃ¡kladnÃ­ kontrola (root)
app.get("/", (req, res) => {
  res.send("ðŸ’› Fio proxy bÄ›Å¾Ã­. PouÅ¾ij endpoint /fio pro JSON vÃ½stup.");
});

// SpuÅ¡tÄ›nÃ­ serveru
app.listen(PORT, () => {
  console.log(`âœ… Server bÄ›Å¾Ã­ na portu ${PORT}`);
});
